doctype html
html(lang='en')
  head
    meta(charset='utf-8')
    meta(http-equiv='X-UA-Compatible', content='IE=edge')
    meta(name='viewport', content='width=device-width, initial-scale=1')

    meta(name='description', content='SuperSecret')
    meta(name='author', content='SuperSecret')
    //- link(rel='icon', href='../../favicon.ico')
    title SuperSecret
    
    // Bootstrap core CSS
    link(href='/css/bootstrap_super.min.css', rel='stylesheet')
    link(href='/css/styles.css', rel='stylesheet')
    
    style.
      @media screen and (max-width: 767px) {
        .sidebar-offcanvas {
          padding-right: 30px;
        }
      }

  body
    nav.navbar.navbar-fixed-top.navbar-inverse
      .container
        .navbar-header
          button.navbar-toggle.collapsed(type='button', data-toggle='collapse', data-target='#navbar', aria-expanded='false', aria-controls='navbar')
            span.sr-only Toggle navigation
            span.icon-bar
            span.icon-bar
            span.icon-bar
          a.navbar-brand(href='#') SuperSecret
        #navbar.collapse.navbar-collapse
          ul.nav.navbar-nav
            li.active
              a(href='#') Home
            
    .container
      .row.row-offcanvas.row-offcanvas-right
        .col-xs-12.col-sm-9
          p.pull-right.visible-xs
            button.btn.btn-primary.btn-xs(type='button', data-toggle='offcanvas') Toggle nav
          .jumbotron
            h1 SuperSecret
            p
              | SuperSecret is an example to show the potential of encryption between your eyes and your computer!
              | Try it out. Sign up, log into the HoloLense SuperSecret app and enjoy super privacy!
            a.btn.btn-success(href='#messageForm') Write a message »
            a.btn.btn-primary.authenticate(href='#' style="margin-left:15px;") Authenticate »
          .row
            .col-lg-12
              form.form-horizontal#messageForm
                fieldset
                  legend Legend
                  .form-group
                    label.col-lg-2.control-label(for='inputEmail') Email
                    .col-lg-10
                      input#inputEmail.form-control(type='text', placeholder='Email', name='recipient')
                  .form-group
                    label.col-lg-2.control-label(for='textArea', name='message') Textarea
                    .col-lg-10
                      textarea#textArea.form-control(rows='7')
                      span.help-block
                        | A longer block of help text that breaks onto a new line and may extend beyond one line.
                  .form-group
                    .col-lg-10.col-lg-offset-2
                      button.btn.btn-default(type='reset') Cancel
                      button.btn.btn-success(type='submit') Submit

                
                
                
                
        #sidebar.col-xs-6.col-sm-3.sidebar-offcanvas
          h3 Hello
          span.help-block
            | Please sign up here to try the HoloLense SuperSecret!
            br
            a.btn.btn-primary.authenticate(href='#' style="margin-top:15px;") Authenticate »
          h3 Users
          span.help-block
            | Klick on a user to send a message. No need to login for that.
          .list-group(style=' max-height: 600px; overflow: scroll;')
            each i in [1,2,3,4,5,4,5,6,7,8,9,4,4,4,4,4,4,4,2,2,2,2,2,2,2,22,2,2,3]
              a.list-group-item.contact(href='#') Hans
              
              
      hr
      footer
        p © 2017 Invisible Slime Worms, Inc.

    .modal#qrModal
      .modal-dialog
        .modal-content
          .modal-header
            button.close(type='button', data-dismiss='modal', aria-hidden='true') ×
            h4.modal-title SuperSecret Delivery Bot
          .modal-body

            .alert.alert-dismissible.alert-success
              strong Success
              br
              | Your message was saved.
              | Please share the image with the reciepent or send him this link!
              br
              a.alert-link.qrLink(href='#' style='text-decoration: underline') .
            p.text-center 
              img.qrImage.text-center(src="" style='padding: 25px;')
          .modal-footer
            button.btn.btn-default(type='button', data-dismiss='modal') Close

    script(src='https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js')
    script(src='/js/bootstrap.min.js')
    script(src="https://cdn.auth0.com/js/lock/10.12.1/lock.min.js")

    script.
      $( ".contact" ).click(function(e) {
        $('#inputEmail').val($(e.target).html());
        $('#textArea').focus();

      });

    script.
      // Construct an instance of Auth0Lock with your clientId and aut0 domain name
      var lock = new Auth0Lock('#{env.AUTH0_CLIENT_ID}', '#{env.AUTH0_DOMAIN}',{ auth: {
            redirectUrl: '#{callbackURL}'
          , responseType: 'code'
          , params: {
            scope: 'openid name email picture'
          }
        },
        languageDictionary: {
          title: "SuperSecret"
        }});

      // Show lock's login widget
      $( ".authenticate" ).click(function(e) {
        lock.show();
      });
      
    script.
      $(document).ready(function () {
        $('[data-toggle="offcanvas"]').click(function () {
          $('.row-offcanvas').toggleClass('active')
        });
      });
    
    script.
      $(function() {
        if ($("form#messageForm").length) {
          $('form#messageForm').submit(function(e) {

            if (e.preventDefault) e.preventDefault();
            else e.returnValue = false;

            var thisForm = $(this).closest('#messageForm');
            
            //- if (validate(false) == false) return false

            jQuery.ajax({
              type: "POST",
              url: "/messages/create",
              data: thisForm.serialize(),
              success: function(response) {
                showQrModal(response)
              },
              error: function() {
                showErrorModal()
              }
            });
            return false;
          });
        }
        
        function showQrModal(response){
          imageURL = window.location.origin + "/messages/image/" + response
          showURL = window.location.origin + "/messages/show/" + response
          $('#qrModal .qrLink').attr("href", showURL).html(showURL)
          console.log(imageURL)
          $('#qrModal .qrImage').attr("src", imageURL)
          
          $('#qrModal').modal('show');
        }
        
        function showErrorModal(){
          $('#qrModal .modal-body').html('<h2>Error. Message not sent. Ask for help!</h2>');
          $('#qrModal').modal('show');        
        }
        
      });
